<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>hell86 VM Crackme | by ttlhacker</title>
<meta
  name="description"
  content="This is my write up on hell86 crackme from crackmes.one authored by ttlhacker. This was a wonderful crackme that I enjoyed doing. I implemented a debugger in C and also emulated it to get its execution trace as well."
/>
<link rel="canonical" href="http://localhost:1313/posts/hell86vm_ttlhacker/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/japanese-gate.png" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/wolf_square_hu5e2579434ed3290475748bc13fedcedd_222518_80x80_fill_q90_box_smart1.jpg 80w"
      src="/img/wolf_square.jpg"
      width="978"
      height="1214"
      alt="AmunRha&#39;s Blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">AmunRha&#39;s Blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        About me
      </a>
      <span class="text-red-900 text-lg">.</span>
    </li>
    
    <li>
      <a href="/posts" class="">
        Posts
      </a>
      <span class="text-red-900 text-lg">.</span>
    </li>
    
    <li>
      <a href="/categories" class="">
        Categories
      </a>
      <span class="text-red-900 text-lg">.</span>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
      <span class="text-red-900 text-lg">.</span>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h1 class="title-large">hell86 VM Crackme | by ttlhacker</h2>

    <div class="meta">
      
      <time datetime="2021-06-26 00:00:00 &#43;0000 UTC" title='Sat, Jun 26, 2021, 12:00 AM UTC'>
        26/06/2021 - Estimated reading time: 10 minutes
      </time>

       
       â€” 
        
          <a class="categories" href="/categories/reverse-engineering/" alt="Reverse Engineering">
            Reverse Engineering
          </a>
         
      
    </div>
  </header>

  
  <aside class="table-of-contents">
    <h2 class="title-small">Table of Contents</h2>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#description">Description</a></li>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#solution">Solution</a>
      <ul>
        <li><a href="#signal-stack-initialization">Signal Stack initialization</a></li>
        <li><a href="#setting-the-signal-handler">Setting the signal handler</a></li>
        <li><a href="#generating-the-first-sigill">Generating the first SIGILL</a>
          <ul>
            <li><a href="#what-is-ud2-instruction">What is <code>ud2</code> instruction?</a></li>
          </ul>
        </li>
        <li><a href="#vm-handler">VM handler</a></li>
        <li><a href="#disassembling-the-vm-opcodes">Disassembling the VM opcodes</a></li>
        <li><a href="#writing-a-debugger-kinda">Writing a debugger (kinda)</a></li>
        <li><a href="#reading-the-disassembled-code">Reading the disassembled code</a></li>
        <li><a href="#writing-the-decryption-algorithm">Writing the decryption algorithm</a></li>
        <li><a href="#conclusion">Conclusion</a></li>
        <li><a href="#references">References</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </aside>


  <section><h2 id="description">Description</h2>
<blockquote>
<p>x86_64 linux binary (tested on debian 9 and ubuntu 18.04, should run on any distro). Takes one command line argument and outputs &ldquo;OK!&rdquo; if it&rsquo;s correct, &ldquo;Wrong&rdquo; if it&rsquo;s not.
Partially written in C, actual verification routine is assembly.
Don&rsquo;t patch the binary, of course - find the correct input.</p>
</blockquote>
<p>Challenge Author: ttlhacker</p>
<h2 id="introduction">Introduction</h2>
<p>This is a wonderful VM crackme that I have ever tried. Since this is my 2nd VM challenge that I have tried, I used the maximum amount of time I can to understand it and try every possible ideas I had in mind, and also cleared out a bunch of doubts and confusions I had as well.</p>
<p>Special Thanks to <a href="https://x3ero0.github.io/">@x3ero0</a> giving out some tips ;)</p>
<p>This is going to be my version of the hell86 solution in the way I understood it, please feel free to point out any error in my analysis.</p>
<h2 id="solution">Solution</h2>
<p>So let us start with the special case of this VM.</p>
<p>This VM works by defining a signal handler for the opcode <code>ud2</code> which will generate a Illegal Signal, or SIGILL.</p>
<p>The VM also defines a separate alternative stack allocated at the heap.</p>
<p>There are many great write ups out there who can explain how the signal handling works, so I am not going to go in depth about it.</p>
<p>The <code>main()</code> function calls in 3 other functions,</p>
<ul>
<li>Initializing the Signal Stack</li>
<li>Initializing the Signal Handler</li>
<li>Calling first <code>ud2</code> instruction to start of the signal handling routine.</li>
</ul>





<figure class='flex justify-center mb-5'>
  <img src="/posts/hell86vm_ttlhacker/Untitled.png"  width="547" height="381" />
  
  
</figure>
<h3 id="signal-stack-initialization">Signal Stack initialization</h3>





<figure class='flex justify-center mb-5'>
  <img src="/posts/hell86vm_ttlhacker/Untitled%201.png"  width="707" height="489" />
  
  
</figure>
<p>We can see that the <code>malloc</code> is called with the size as <code>0x2000</code> and the ptr is then passed as the stack pointer for the alternative signal stack.</p>
<h3 id="setting-the-signal-handler">Setting the signal handler</h3>





<figure class='flex justify-center mb-5'>
  <img src="/posts/hell86vm_ttlhacker/Untitled%202.png"  width="687" height="566" />
  
  
</figure>
<p>You can see here that the signal handler function is being set in the signal struct and the func <code>sigaction</code> is being passed with the struct.</p>
<h3 id="generating-the-first-sigill">Generating the first SIGILL</h3>





<figure class='flex justify-center mb-5'>
  <img src="/posts/hell86vm_ttlhacker/Untitled%203.png"  width="769" height="114" />
  
  
</figure>
<p>As you can see here, the first <code>ud2</code> instruction is executed. But what is <code>ud2</code> ?</p>
<h4 id="what-is-ud2-instruction">What is <code>ud2</code> instruction?</h4>
<p><code>ud2</code> instruction is opcode value which will generate a &ldquo;invalid opcode exception&rdquo;. This is mostly used in software testing to intentionally generate a invalid opcode exception. Intel guarantees that this opcode will always be a undefined instruction.</p>
<p>So what has this got to do with our VM?</p>
<p>This special instruction will generate the <code>SIGILL</code> signal, which the VM is dependent on to execute all its other opcode.</p>
<p>To simply say, whenever <code>ud2</code> is called, <code>SIGILL</code> is generated, which is handled by the custom VM function which then starts with parsing the next 14 bytes from the <code>ud2</code> instruction into a structure which will be used to execute our VM opcodes and its respective operations.</p>
<h3 id="vm-handler">VM handler</h3>





<figure class='flex justify-center mb-5'>
  <img src="/posts/hell86vm_ttlhacker/Untitled%204.png"  width="555" height="311" />
  
  
</figure>
<p>As you can see this is the start of the VM handler where the structures are initialized.</p>
<p>After analyzing the switch cases, I managed to recover 2 main structures,</p>
<ul>
<li>
<p>The VM struct</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> vm_struct{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">uint64_t</span> reg0;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">uint8_t</span> opcode;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">uint8_t</span> reg1;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">uint8_t</span> reg2;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">uint8_t</span> reg3;  
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div></li>
<li>
<p>The bytecode struct</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> bcode_struct
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">uint64_t</span> mem[<span style="color:#bd93f9">15</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">uint64_t</span> sp;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">uint64_t</span> pc;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div></li>
</ul>
<p>The first one was the structure responsible for storing the bytes appropriately parsed from every 14 bytes after every <code>ud2</code> instruction.</p>
<p>The second one is the bytecode structure is more like a memory region in which the values are stored, and further used for the operations defined. It also points to the next block of VM bytes to execute and the alternative stack address that we were speaking about in the beginning.</p>
<p><em>p.s. If you have read other write ups or solved the challenge before, you might already see that I didn&rsquo;t see something very obvious in the structure pattern, which I shall explain at the end of this write up</em></p>
<p>So, we can see that program counter is updated at the start to point to the next 14 bytes after every <code>ud2</code> instruction.</p>
<h3 id="disassembling-the-vm-opcodes">Disassembling the VM opcodes</h3>
<p>There are total of 50 well defined opcodes in this VM, but we don&rsquo;t need to concern with all of them. I ran a small check on which all opcodes are actually used in the given bytecode segment, and only implemented those.</p>
<p>There was in total of 23 opcodes which were used out of the 50 ones which are defined, so that became an easier task than analyzing all of the opcodes.</p>
<p><em>Spoiler alert! or not, most of the opcodes are implemented in the same way as in the x86 assembly. Well, the challenge name ain&rsquo;t lying.</em></p>
<p>There were opcodes to handle most of the arithmetic operations, opcodes to push and pop the stack, opcodes to call functions <em>(yup, there are separate block of vm bytecode for different functions)</em>, and return statements from those functions.</p>
<p>I chose C to write its disassembler.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#6272a4">// snipping out the previous code here
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">switch</span> (vm.opcode)
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> <span style="color:#bd93f9">0x1</span> <span style="color:#ff79c6">:</span> 
</span></span><span style="display:flex;"><span>          bcode.mem[vm.reg1] <span style="color:#ff79c6">=</span> bcode.mem[vm.reg2] <span style="color:#ff79c6">+</span> bcode.mem[vm.reg3];
</span></span><span style="display:flex;"><span>          <span style="color:#50fa7b">printf</span>(disasm_ins[<span style="color:#bd93f9">0</span>], vm.reg1, vm.reg2, vm.reg3);
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> <span style="color:#bd93f9">0x2</span> <span style="color:#ff79c6">:</span> 
</span></span><span style="display:flex;"><span>          bcode.mem[vm.reg1] <span style="color:#ff79c6">=</span> bcode.mem[vm.reg2] <span style="color:#ff79c6">-</span> bcode.mem[vm.reg3];
</span></span><span style="display:flex;"><span>          <span style="color:#50fa7b">printf</span>(disasm_ins[<span style="color:#bd93f9">1</span>], vm.reg1, vm.reg2, vm.reg3);
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> <span style="color:#bd93f9">0x3</span> <span style="color:#ff79c6">:</span> 
</span></span><span style="display:flex;"><span>          bcode.mem[vm.reg1] <span style="color:#ff79c6">=</span> bcode.mem[vm.reg2] <span style="color:#ff79c6">*</span> bcode.mem[vm.reg3];
</span></span><span style="display:flex;"><span>          <span style="color:#50fa7b">printf</span>(disasm_ins[<span style="color:#bd93f9">2</span>], vm.reg1, vm.reg2, vm.reg3);
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> <span style="color:#bd93f9">0x8</span> <span style="color:#ff79c6">:</span> 
</span></span><span style="display:flex;"><span>          bcode.mem[vm.reg1] <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span>bcode.mem[vm.reg2];
</span></span><span style="display:flex;"><span>          <span style="color:#50fa7b">printf</span>(disasm_ins[<span style="color:#bd93f9">3</span>], vm.reg1, vm.reg2);
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// snipping out the rest of the code here.
</span></span></span></code></pre></div><h3 id="writing-a-debugger-kinda">Writing a debugger (kinda)</h3>
<p>Well, writing disassembler wasn&rsquo;t enough for me, I wanted as much information from the VM that I can and also I only wanted to see instructions which were executed (like a trace). I went ahead and emulated all the VM instructions in my script finally managing to write a debugger with it to get all the information that I wanted.</p>
<p>At some places, we can see there are addresses pointing to places in the opcode array. Such addresses are relocatable addresses in the binary, and hence will change their position each time. Rather than taking a dump of the running binary, I just took the last 3 nibbles which didn&rsquo;t seem to change and used that to dereference the array elements.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>bcode.vm_bbl <span style="color:#ff79c6">=</span> (<span style="color:#8be9fd">int</span>)(vm.reg0 <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">0xfff</span>) <span style="color:#ff79c6">-</span> (<span style="color:#8be9fd">int</span>)BBL_BASE_OFF;
</span></span></code></pre></div><p>That&rsquo;s when I realized that there were a few address which wasn&rsquo;t in the range of offsets of the bytecode and I was confused. They were being dereferenced, although I had a logic implemented to tackle that, this was weird. So, I tried to debug those instructions, it seemed there was <code>malloc</code> and <code>free</code> called inside VM (<em>ftw</em>). Well, since that&rsquo;s the case, I implemented a workaround for that, by initializing an array named heap and just pointed the return address to that.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ff79c6">----------</span> META DATA <span style="color:#ff79c6">-----------</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ff79c6">+</span>] Addr of <span style="color:#8be9fd;font-style:italic">inp</span>: <span style="color:#bd93f9">0x55d80604b820</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ff79c6">+</span>] Addr of ptr to <span style="color:#8be9fd;font-style:italic">inp</span>: <span style="color:#bd93f9">0x55d80604bd68</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ff79c6">+</span>] Addr of <span style="color:#8be9fd;font-style:italic">stack</span>: <span style="color:#bd93f9">0x55d80604bf60</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ff79c6">+</span>] Addr of <span style="color:#8be9fd;font-style:italic">heap</span>: <span style="color:#bd93f9">0x55d80604be60</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ff79c6">+</span>] Addr of offset <span style="color:#8be9fd;font-style:italic">check</span>: <span style="color:#bd93f9">0x55d80604b8a0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ff79c6">+</span>] Addr of ascii <span style="color:#8be9fd;font-style:italic">chars</span>: <span style="color:#bd93f9">0x55d80604b860</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">---------------------------------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x0</span>] [<span style="color:#bd93f9">0</span>] OPCODE <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x9</span> <span style="color:#ff79c6">---------</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">---------</span> REG VALS <span style="color:#ff79c6">---------</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ff79c6">*</span>] reg0 <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x2</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ff79c6">*</span>] reg1 <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0xd</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ff79c6">*</span>] reg2 <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ff79c6">*</span>] reg3 <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">---------</span> BCODE STRUCT <span style="color:#ff79c6">---------</span>
</span></span><span style="display:flex;"><span>mem {
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x0</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x1</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x2</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x3</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x4</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x5</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x6</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x7</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x8</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x2</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x9</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x55d80604bd60</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0xa</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x55d80604bd60</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0xb</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0xc</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0xd</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0xe</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>res    <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x55d80604bfc8</span> (stack[<span style="color:#bd93f9">0xd</span>])
</span></span><span style="display:flex;"><span>vm_bbl <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">---------</span> STACK <span style="color:#ff79c6">---------</span>
</span></span><span style="display:flex;"><span>stack { <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x1010101</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, }
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">---------</span> HEAP <span style="color:#ff79c6">---------</span>
</span></span><span style="display:flex;"><span>heap { <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, <span style="color:#bd93f9">0x0</span>, }
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">--------------------------------------</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0xd</span>], <span style="color:#bd93f9">0x2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0xe</span>] [<span style="color:#bd93f9">1</span>] OPCODE <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x24</span> <span style="color:#ff79c6">---------</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">---------</span> REG VALS <span style="color:#ff79c6">---------</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ff79c6">*</span>] reg0 <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x2</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ff79c6">*</span>] reg1 <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ff79c6">*</span>] reg2 <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x8</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ff79c6">*</span>] reg3 <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">---------</span> BCODE STRUCT <span style="color:#ff79c6">---------</span>
</span></span><span style="display:flex;"><span>mem {
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x0</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x1</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x2</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x3</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x4</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x5</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x6</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x7</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x8</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x2</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0x9</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x55d80604bd60</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0xa</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x55d80604bd60</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0xb</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0xc</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0xd</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x2</span>
</span></span><span style="display:flex;"><span>[<span style="color:#bd93f9">0xe</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x0</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// snipping out rest of the output here
</span></span></span></code></pre></div><p><em>Part of the disassembly printed with debugger info</em></p>
<h3 id="reading-the-disassembled-code">Reading the disassembled code</h3>
<p>After executing my VM script with sample outputs, I concluded the following.</p>
<ol>
<li>Flag length must be 0x24</li>
<li>Checks if input contains &ldquo;FLAG{&rdquo; at the start and &ldquo;}&rdquo; at the end</li>
<li>Checks if the flag is all lowercase+numbers+special_chars and no uppercases,
<ol>
<li>Allowed characters â€” <code>abdfgehikmanoqrstucvwlxyz-01h23p456u78j9-_.+</code></li>
</ol>
</li>
<li>Gets the index from the allowed array from matching with your input, thereby forming an array of index from the allowed set. This is stored into the heap returned by the malloc (in our case the heap array)</li>
<li>Encryption algorithm gets executed and stores the encrypted value back to the heap</li>
<li>Final resulting bytes are checked with a stored array of encrypted bytes.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#6272a4">// snipping out previous disassembly here
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>mov mem[<span style="color:#bd93f9">0x2</span>], <span style="color:#bd93f9">0x5623e4e60860</span>
</span></span><span style="display:flex;"><span>sub mem[<span style="color:#bd93f9">0xd</span>], mem[<span style="color:#bd93f9">0xd</span>] <span style="color:#ff79c6">-</span> mem[<span style="color:#bd93f9">0x2</span>]
</span></span><span style="display:flex;"><span>mov _QWORD[mem[<span style="color:#bd93f9">0x1</span>]<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x0</span>], mem[<span style="color:#bd93f9">0xd</span>]
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x1</span>], mem[<span style="color:#bd93f9">0x1</span>] <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x8</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x8</span>], mem[<span style="color:#bd93f9">0x8</span>] <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x1</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x9</span>], mem[<span style="color:#bd93f9">0x9</span>] <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0xffffffffffffffff</span>
</span></span><span style="display:flex;"><span>cmp mem[<span style="color:#bd93f9">0x9</span>], <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>jnz <span style="color:#bd93f9">0x5591cf15a4a0</span>
</span></span><span style="display:flex;"><span>push mem[<span style="color:#bd93f9">0x1</span>]
</span></span><span style="display:flex;"><span>push mem[<span style="color:#bd93f9">0x0</span>]
</span></span><span style="display:flex;"><span>push mem[<span style="color:#bd93f9">0x8</span>]
</span></span><span style="display:flex;"><span>push mem[<span style="color:#bd93f9">0x9</span>]
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x9</span>], _BYTE[mem[<span style="color:#bd93f9">0x8</span>]<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x0</span>]
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x8</span>], <span style="color:#bd93f9">0x5623e4e60860</span>
</span></span><span style="display:flex;"><span>call <span style="color:#bd93f9">0x5591cf15a8c8</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0xd</span>], mem[<span style="color:#bd93f9">0x8</span>]
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x0</span>], _BYTE[mem[<span style="color:#bd93f9">0xd</span>]<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x0</span>]
</span></span><span style="display:flex;"><span>cmp mem[<span style="color:#bd93f9">0x0</span>], <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>jz <span style="color:#bd93f9">0x5591cf15a92a</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x0</span>], mem[<span style="color:#bd93f9">0x0</span>] <span style="color:#ff79c6">==</span> mem[<span style="color:#bd93f9">0x9</span>]
</span></span><span style="display:flex;"><span>ret <span style="color:#ff79c6">if</span> mem[<span style="color:#bd93f9">0x0</span>] <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0xd</span>], mem[<span style="color:#bd93f9">0xd</span>] <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x1</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x10</span>], <span style="color:#bd93f9">0x5591cf15a8d6</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x0</span>], _BYTE[mem[<span style="color:#bd93f9">0xd</span>]<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x0</span>]
</span></span><span style="display:flex;"><span>cmp mem[<span style="color:#bd93f9">0x0</span>], <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>jz <span style="color:#bd93f9">0x5591cf15a92a</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x0</span>], mem[<span style="color:#bd93f9">0x0</span>] <span style="color:#ff79c6">==</span> mem[<span style="color:#bd93f9">0x9</span>]
</span></span><span style="display:flex;"><span>ret <span style="color:#ff79c6">if</span> mem[<span style="color:#bd93f9">0x0</span>] <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0xd</span>], mem[<span style="color:#bd93f9">0xd</span>] <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x1</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x10</span>], <span style="color:#bd93f9">0x5591cf15a8d6</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x0</span>], _BYTE[mem[<span style="color:#bd93f9">0xd</span>]<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x0</span>]
</span></span><span style="display:flex;"><span>cmp mem[<span style="color:#bd93f9">0x0</span>], <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>jz <span style="color:#bd93f9">0x5591cf15a92a</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x0</span>], mem[<span style="color:#bd93f9">0x0</span>] <span style="color:#ff79c6">==</span> mem[<span style="color:#bd93f9">0x9</span>]
</span></span><span style="display:flex;"><span>ret <span style="color:#ff79c6">if</span> mem[<span style="color:#bd93f9">0x0</span>] <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0xd</span>], mem[<span style="color:#bd93f9">0xd</span>] <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x1</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x10</span>], <span style="color:#bd93f9">0x5591cf15a8d6</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x0</span>], _BYTE[mem[<span style="color:#bd93f9">0xd</span>]<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x0</span>]
</span></span><span style="display:flex;"><span>cmp mem[<span style="color:#bd93f9">0x0</span>], <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>jz <span style="color:#bd93f9">0x5591cf15a92a</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x0</span>], mem[<span style="color:#bd93f9">0x0</span>] <span style="color:#ff79c6">==</span> mem[<span style="color:#bd93f9">0x9</span>]
</span></span><span style="display:flex;"><span>ret <span style="color:#ff79c6">if</span> mem[<span style="color:#bd93f9">0x0</span>] <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0xd</span>], mem[<span style="color:#bd93f9">0xd</span>] <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x1</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x10</span>], <span style="color:#bd93f9">0x5591cf15a8d6</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x0</span>], _BYTE[mem[<span style="color:#bd93f9">0xd</span>]<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x0</span>]
</span></span><span style="display:flex;"><span>cmp mem[<span style="color:#bd93f9">0x0</span>], <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>jz <span style="color:#bd93f9">0x5591cf15a92a</span>
</span></span><span style="display:flex;"><span>mov mem[<span style="color:#bd93f9">0x0</span>], mem[<span style="color:#bd93f9">0x0</span>] <span style="color:#ff79c6">==</span> mem[<span style="color:#bd93f9">0x9</span>]
</span></span><span style="display:flex;"><span>ret <span style="color:#ff79c6">if</span> mem[<span style="color:#bd93f9">0x0</span>] <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// snipping out rest of the disassembly here
</span></span></span></code></pre></div><p><em>Part of the cleaner disassembly printed without debugger info</em></p>
<h3 id="writing-the-decryption-algorithm">Writing the decryption algorithm</h3>
<p>Since the algorithm is fairly simple, I went for brute forcing the flag bytes. The range was set to the allowed characters, and the encryption routine was called in checking if it matches the final result.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ff79c6">##include&lt;stdio.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">##include&lt;stdint.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int64_t</span> enc[] <span style="color:#ff79c6">=</span> {<span style="color:#bd93f9">0x16C8</span>, <span style="color:#bd93f9">0x0FFFFFFFFFFFF8BA1</span>, <span style="color:#bd93f9">0x0FFFFFFFFFFFFE0C0</span>, <span style="color:#bd93f9">0x3600</span>, <span style="color:#bd93f9">0x0FFFFFFFFFFFFE535</span>, <span style="color:#bd93f9">0x16C8</span>, <span style="color:#bd93f9">0x0FFFFFFFFFFFF8BA1</span>, <span style="color:#bd93f9">0x5F45</span>, <span style="color:#bd93f9">0x0FFFFFFFFFFFFD668</span>, <span style="color:#bd93f9">0x0FFFFFFFFFFFFFFF8</span>, <span style="color:#bd93f9">0x5F45</span>, <span style="color:#bd93f9">0x0FFFFFFFFFFFFCA00</span>, <span style="color:#bd93f9">0x0FFFFFFFFFFFFBB58</span>, <span style="color:#bd93f9">0x0AB8</span>, <span style="color:#bd93f9">0x0FFFFFFFFFFFFBB58</span>, <span style="color:#bd93f9">0x4CE3</span>, <span style="color:#bd93f9">0x0FFFFFFFFFFFF8000</span>, <span style="color:#bd93f9">0x2D9</span>, <span style="color:#bd93f9">0x4CE3</span>, <span style="color:#bd93f9">0x0FFFFFFFFFFFFFFFF</span>, <span style="color:#bd93f9">0x2D9</span>, <span style="color:#bd93f9">0x3E8</span>, <span style="color:#bd93f9">0x7D</span>, <span style="color:#bd93f9">0x0FFFFFFFFFFFFE938</span>, <span style="color:#bd93f9">0x200</span>, <span style="color:#bd93f9">0x200</span>, <span style="color:#bd93f9">0x0FFFFFFFFFFFFE535</span>, <span style="color:#bd93f9">0x1F40</span>, <span style="color:#bd93f9">0x0FFFFFFFFFFFFE0C0</span>, <span style="color:#bd93f9">0x0</span>};
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int64_t</span> loff[<span style="color:#bd93f9">30</span>] <span style="color:#ff79c6">=</span> {<span style="color:#bd93f9">0</span>};
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int64_t</span> lenc[<span style="color:#bd93f9">30</span>] <span style="color:#ff79c6">=</span> {<span style="color:#bd93f9">0</span>};
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">char</span> inp[] <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;x86defghijklmnopqrstuvwxyz01234&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">char</span> ascii[] <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;abdfgehikmanoqrstucvwlxyz-01h23p456u78j9-_.+&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">encrypt</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> k <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x1e</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span>(<span style="color:#8be9fd">int</span> i<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>;i<span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">30</span>;i<span style="color:#ff79c6">++</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span> a <span style="color:#ff79c6">=</span> (loff[i<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">-</span> loff[i]) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">--</span>k;
</span></span><span style="display:flex;"><span>        a <span style="color:#ff79c6">=</span> a <span style="color:#ff79c6">*</span> a <span style="color:#ff79c6">*</span> a;
</span></span><span style="display:flex;"><span>        lenc[i] <span style="color:#ff79c6">=</span> a;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">find_off</span>(<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>inp){
</span></span><span style="display:flex;"><span>    loff[<span style="color:#bd93f9">29</span>] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x1e</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span>(<span style="color:#8be9fd">int</span> i<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>;i<span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">30</span>;i<span style="color:#ff79c6">++</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span>(<span style="color:#8be9fd">int</span> j<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>;j<span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">44</span>;j<span style="color:#ff79c6">++</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span>(inp[i] <span style="color:#ff79c6">==</span> ascii[j]){
</span></span><span style="display:flex;"><span>                loff[i] <span style="color:#ff79c6">=</span> j; <span style="color:#6272a4">// stores the idx found
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">main</span>(){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> k <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">printf</span>(<span style="color:#f1fa8c">&#34;FLAG{x&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span>(<span style="color:#8be9fd">int</span> i<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>;i<span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">44</span>;i<span style="color:#ff79c6">++</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span>(k <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">30</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>        inp[k] <span style="color:#ff79c6">=</span> ascii[i]; <span style="color:#6272a4">// tries all possible characters in the set
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">find_off</span>(inp);
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">encrypt</span>(loff);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span>(lenc[k<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">==</span> enc[k<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]){
</span></span><span style="display:flex;"><span>            k<span style="color:#ff79c6">+=</span><span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#50fa7b">printf</span>(<span style="color:#f1fa8c">&#34;%c&#34;</span>, ascii[i]);
</span></span><span style="display:flex;"><span>            i<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">printf</span>(<span style="color:#f1fa8c">&#34;}</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Running this gives out our flag!</p>





<figure class='flex justify-center mb-5'>
  <img src="/posts/hell86vm_ttlhacker/Untitled%205.png"  width="312" height="102" />
  
  
</figure>
<p>Flag: <code>FLAG{x86-1s-s0-fund4m3nt4lly-br0k3n}</code></p>
<h3 id="conclusion">Conclusion</h3>
<p>As I said, I eventually realized while discussing about this and reading the write ups that I missed something.</p>
<p>The VM structure of this binary is the similar to the x64 registers struct, and it is the one which is used throughout the whole execution. It uses the actual x64 registers, and not a new one. This also explains why the structure changed its values after the <code>malloc</code> and <code>free</code> call.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * The 64-bit signal frame:
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> sigcontext_64 {
</span></span><span style="display:flex;"><span>	__u64				r8;
</span></span><span style="display:flex;"><span>	__u64				r9;
</span></span><span style="display:flex;"><span>	__u64				r10;
</span></span><span style="display:flex;"><span>	__u64				r11;
</span></span><span style="display:flex;"><span>	__u64				r12;
</span></span><span style="display:flex;"><span>	__u64				r13;
</span></span><span style="display:flex;"><span>	__u64				r14;
</span></span><span style="display:flex;"><span>	__u64				r15;
</span></span><span style="display:flex;"><span>	__u64				di;
</span></span><span style="display:flex;"><span>	__u64				si;
</span></span><span style="display:flex;"><span>	__u64				bp;
</span></span><span style="display:flex;"><span>	__u64				bx;
</span></span><span style="display:flex;"><span>	__u64				dx;
</span></span><span style="display:flex;"><span>	__u64				ax;
</span></span><span style="display:flex;"><span>	__u64				cx;
</span></span><span style="display:flex;"><span>	__u64				sp;
</span></span><span style="display:flex;"><span>	__u64				ip;
</span></span><span style="display:flex;"><span>	__u64				flags;
</span></span><span style="display:flex;"><span>	__u16				cs;
</span></span><span style="display:flex;"><span>	__u16				gs;
</span></span><span style="display:flex;"><span>	__u16				fs;
</span></span><span style="display:flex;"><span>	__u16				ss;
</span></span><span style="display:flex;"><span>	__u64				err;
</span></span><span style="display:flex;"><span>	__u64				trapno;
</span></span><span style="display:flex;"><span>	__u64				oldmask;
</span></span><span style="display:flex;"><span>	__u64				cr2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">	 * fpstate is really (struct _fpstate *) or (struct _xstate *)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">	 * depending on the FP_XSTATE_MAGIC1 encoded in the SW reserved
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">	 * bytes of (struct _fpstate) and FP_XSTATE_MAGIC2 present at the end
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">	 * of extended memory layout. See comments at the definition of
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">	 * (struct _fpx_sw_bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">	 */</span>
</span></span><span style="display:flex;"><span>	__u64				fpstate; <span style="color:#6272a4">/* Zero when no FPU/extended context */</span>
</span></span><span style="display:flex;"><span>	__u64				reserved1[<span style="color:#bd93f9">8</span>];
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>And therefore you can use gdb or any other elf debugger to debug this VM.</p>
<p>So, that&rsquo;s it folks, that is my solution to the hell86 crackme.</p>
<p>Disassembler,
<script src="https://gist.github.com/AmunRha/2396f09357bb5ef102af9ad48fb58cb7.js?file=_hell86_disasm.c"></script>
</p>
<p>Decrypter,
<script src="https://gist.github.com/AmunRha/2396f09357bb5ef102af9ad48fb58cb7.js?file=hell86_decrypt.c"></script>
</p>
<p>Link:</p>
<ul>
<li><a href="https://gist.github.com/AmunRha/2396f09357bb5ef102af9ad48fb58cb7##file-_hell86_disasm-c">hell86_disassembler.c</a></li>
<li><a href="https://gist.github.com/AmunRha/2396f09357bb5ef102af9ad48fb58cb7##file-hell86_decrypt-c">hell86_decrypt.c</a></li>
</ul>
<h3 id="references">References</h3>
<ul>
<li>
<p><a href="https://hjlebbink.github.io/x86doc/html/UD2.html">https://hjlebbink.github.io/x86doc/html/UD2.html</a></p>
</li>
<li>
<p><a href="https://man7.org/linux/man-pages/man7/signal.7.html">https://man7.org/linux/man-pages/man7/signal.7.html</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/x64-architecture">https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/x64-architecture</a></p>
</li>
<li>
<p><a href="https://github.com/torvalds/linux/blob/master/arch/x86/include/uapi/asm/sigcontext.h">https://github.com/torvalds/linux/blob/master/arch/x86/include/uapi/asm/sigcontext.h</a></p>
</li>
</ul>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/crackme/" alt="Crackme">
          Crackme
        </a>
      
        <a href="/tags/vm/" alt="VM">
          VM
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  Â© 2024 â€”
  <a href="http://localhost:1313/">AmunRha&#39;s Blog</a> 
  <span class="font-normal">with</span>
  <a
    href="https://github.com/nixentric/Lowkey-Hugo-Theme"
    target="_blank"
    rel="noopener noreferrer"
  >
    Lowkey
  </a>
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://twitter.com/amun_rha" target="_blank" rel="noopener noreferrer">Twitter</a>
    </li>
    
    <li>    
      <a href="https://linkedin.com/in/adhithyasureshk" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/AmunRha" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
